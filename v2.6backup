// ==UserScript==
// @name         Etsy Auto Lister v2.6 (backup)
// @namespace    http://tampermonkey.net/
// @version      2.6
// @description  Cáº­p nháº­t ID nÃºt Confirm Publish, giá»¯ nguyÃªn Scroll Tag & Slow Type.
// @author       Gemini Expert
// @match        https://www.etsy.com/your/shops/*/tools/listings*
// @match        https://www.etsy.com/your/shops/*/listing-editor/*
// @grant        GM_addStyle
// @grant        GM_setValue
// @grant        GM_getValue
// @grant        GM_xmlhttpRequest
// @run-at       document-idle
// ==/UserScript==

(function() {
Â  Â  'use strict';

Â  Â  // --- Cáº¤U HÃŒNH (ÄÃ£ tÄƒng thá»i gian Ä‘á»£i) ---
Â  Â  const CONFIG = {
Â  Â  Â  Â  delay: {
Â  Â  Â  Â  Â  Â  step: 800,Â  Â  Â  Â  Â  // Tá»‘c Ä‘á»™ thao tÃ¡c chung
Â  Â  Â  Â  Â  Â  load: 5000,Â  Â  Â  Â  Â // Chá» trang copy load xong
Â  Â  Â  Â  Â  Â  tagTyping: 100,Â  Â  Â // GÃµ cháº­m láº¡i: 100ms má»—i kÃ½ tá»± (Ä‘á»ƒ Etsy ká»‹p nháº­n)
Â  Â  Â  Â  Â  Â  tagWait: 2500,Â  Â  Â  // Chá» 2.5s sau khi báº¥m Add (Ä‘á»ƒ tag ká»‹p vÃ o danh sÃ¡ch)
Â  Â  Â  Â  Â  Â  uploadWait: 15000,Â  // Thá»i gian chá» áº£nh upload
Â  Â  Â  Â  },
Â  Â  Â  Â  selectors: {
Â  Â  Â  Â  Â  Â  titleInput: '#listing-title-input',
Â  Â  Â  Â  Â  Â  // Selector khu vá»±c Tag Ä‘á»ƒ scroll tá»›i
Â  Â  Â  Â  Â  Â  tagSection: '#field-tags',
Â  Â  Â  Â  Â  Â  tagInput: '#listing-tags-input',
Â  Â  Â  Â  Â  Â  tagAddBtn: '#listing-tags-button',
Â  Â  Â  Â  Â  Â  fileInput: 'input[name="listing-media-upload"]',
Â  Â  Â  Â  Â  Â  publishBtn: 'button[data-testid="publish"]',
Â  Â  Â  Â  Â  Â  confirmModalBtn: '#shop-manager--listing-publish, div.wt-overlay button.wt-btn--primary'
Â  Â  Â  Â  }
Â  Â  };

Â  Â  // --- STATE ---
Â  Â  const STATE = {
Â  Â  Â  Â  get isRunning() { return GM_getValue('isRunning', false); },
Â  Â  Â  Â  set isRunning(val) { GM_setValue('isRunning', val); },
Â  Â  Â  Â  get currentIndex() { return GM_getValue('currentIndex', 0); },
Â  Â  Â  Â  set currentIndex(val) { GM_setValue('currentIndex', val); },
Â  Â  Â  Â  get templateId() { return GM_getValue('templateId', ''); },
Â  Â  Â  Â  set templateId(val) { GM_setValue('templateId', val); },
Â  Â  Â  Â  get csvData() { return JSON.parse(localStorage.getItem('etsy_csv_rows') || '[]'); },
Â  Â  Â  Â  set csvData(val) { localStorage.setItem('etsy_csv_rows', JSON.stringify(val)); }
Â  Â  };

Â  Â  // --- UI PANEL ---
Â  Â  function createPanel() {
Â  Â  Â  Â  if (document.getElementById('etsy-auto-panel')) return;

Â  Â  Â  Â  const panel = document.createElement('div');
Â  Â  Â  Â  panel.id = 'etsy-auto-panel';
Â  Â  Â  Â  panel.innerHTML = `
Â  Â  Â  Â  Â  Â  <div class="header">Etsy Auto v2.5 (Slow Tag)</div>
Â  Â  Â  Â  Â  Â  <div class="section">
Â  Â  Â  Â  Â  Â  Â  Â  <label>Template ID:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="ea-template-id" value="${STATE.templateId}" placeholder="VD: 123456789">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="section">
Â  Â  Â  Â  Â  Â  Â  Â  <label>CSV Data (No Header):</label>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="ea-csv-file" accept=".csv">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="controls">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="ea-load-btn" class="btn-blue">Load CSV</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="ea-start-btn" class="btn-green">Start</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="ea-stop-btn" class="btn-red">Stop</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="controls">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="ea-clear-btn" class="btn-gray">ğŸ—‘ï¸ Clear Data</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="status-box">
Â  Â  Â  Â  Â  Â  Â  Â  Row: <span id="ea-row-info">${STATE.currentIndex + 1} / ${STATE.csvData.length}</span>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="ea-status">Ready...</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="section">
Â  Â  Â  Â  Â  Â  Â  Â  <label>Logs:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="ea-logs" readonly></textarea>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  document.body.appendChild(panel);

Â  Â  Â  Â  GM_addStyle(`
Â  Â  Â  Â  Â  Â  #etsy-auto-panel { position: fixed; top: 10px; right: 10px; width: 300px; background: #fff; border: 2px solid #333; z-index: 999999; font-family: sans-serif; font-size: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); border-radius: 8px; }
Â  Â  Â  Â  Â  Â  #etsy-auto-panel .header { background: #222; color: #fff; padding: 8px; font-weight: bold; text-align: center; }
Â  Â  Â  Â  Â  Â  #etsy-auto-panel .section { padding: 8px 10px; border-bottom: 1px solid #eee; }
Â  Â  Â  Â  Â  Â  #etsy-auto-panel label { display: block; font-weight: bold; margin-bottom: 4px; }
Â  Â  Â  Â  Â  Â  #etsy-auto-panel input, #etsy-auto-panel textarea { width: 100%; box-sizing: border-box; padding: 5px; border: 1px solid #ccc; }
Â  Â  Â  Â  Â  Â  #etsy-auto-panel textarea { height: 80px; font-size: 10px; font-family: monospace; }
Â  Â  Â  Â  Â  Â  #etsy-auto-panel .controls { display: flex; gap: 5px; padding: 5px 10px; }
Â  Â  Â  Â  Â  Â  #etsy-auto-panel button { flex: 1; padding: 8px; color: white; border: none; cursor: pointer; border-radius: 4px; font-weight: bold; }
Â  Â  Â  Â  Â  Â  .btn-blue { background: #007bff; } .btn-green { background: #28a745; } .btn-red { background: #dc3545; } .btn-gray { background: #6c757d; }
Â  Â  Â  Â  Â  Â  .status-box { background: #f8f9fa; padding: 8px; text-align: center; border-bottom: 1px solid #eee; }
Â  Â  Â  Â  Â  Â  #ea-status { color: #007bff; margin-top: 4px; font-weight: bold; }
Â  Â  Â  Â  `);

Â  Â  Â  Â  document.getElementById('ea-template-id').addEventListener('change', (e) => STATE.templateId = e.target.value.trim());
Â  Â  Â  Â  document.getElementById('ea-load-btn').addEventListener('click', loadCSV);
Â  Â  Â  Â  document.getElementById('ea-start-btn').addEventListener('click', startProcess);
Â  Â  Â  Â  document.getElementById('ea-stop-btn').addEventListener('click', stopProcess);
Â  Â  Â  Â  document.getElementById('ea-clear-btn').addEventListener('click', clearData);
Â  Â  Â  Â  updateUI();
Â  Â  }

Â  Â  function log(msg) {
Â  Â  Â  Â  const el = document.getElementById('ea-status');
Â  Â  Â  Â  const area = document.getElementById('ea-logs');
Â  Â  Â  Â  if (el) el.innerText = msg;
Â  Â  Â  Â  if (area) area.value = `> ${msg}\n` + area.value;
Â  Â  Â  Â  console.log(`[EtsyAuto] ${msg}`);
Â  Â  }

Â  Â  function updateUI() {
Â  Â  Â  Â  const el = document.getElementById('ea-row-info');
Â  Â  Â  Â  if (el) el.innerText = `${STATE.currentIndex + 1} / ${STATE.csvData.length}`;
Â  Â  }

Â  Â  // --- DATA MANAGEMENT ---
Â  Â  function loadCSV() {
Â  Â  Â  Â  const fileInput = document.getElementById('ea-csv-file');
Â  Â  Â  Â  if (!fileInput.files.length) return alert('ChÆ°a chá»n file CSV!');
Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  reader.onload = function(e) {
Â  Â  Â  Â  Â  Â  const rows = parseCSV(e.target.result);
Â  Â  Â  Â  Â  Â  STATE.csvData = rows;
Â  Â  Â  Â  Â  Â  STATE.currentIndex = 0;
Â  Â  Â  Â  Â  Â  updateUI();
Â  Â  Â  Â  Â  Â  log(`ÄÃ£ load ${rows.length} dÃ²ng.`);
Â  Â  Â  Â  };
Â  Â  Â  Â  reader.readAsText(fileInput.files[0]);
Â  Â  }

Â  Â  function parseCSV(text) {
Â  Â  Â  Â  const lines = text.split(/\r\n|\n/);
Â  Â  Â  Â  const result = [];
Â  Â  Â  Â  for (let line of lines) {
Â  Â  Â  Â  Â  Â  if (!line.trim()) continue;
Â  Â  Â  Â  Â  Â  const regex = /(?:^|,)(\s*"([^"]*(?:""[^"]*)*)"|\s*([^,]*))/g;
Â  Â  Â  Â  Â  Â  let matches = [];
Â  Â  Â  Â  Â  Â  let match;
Â  Â  Â  Â  Â  Â  while (match = regex.exec(line)) {
Â  Â  Â  Â  Â  Â  Â  Â  let val = match[2] ? match[2].replace(/""/g, '"') : match[3];
Â  Â  Â  Â  Â  Â  Â  Â  matches.push(val ? val.trim() : '');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (matches.length > 0 && matches[0]) {
Â  Â  Â  Â  Â  Â  Â  Â  result.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: matches[0],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tags: matches[1] || '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  images: matches.slice(2).filter(u => u.startsWith('http'))
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  return result;
Â  Â  }

Â  Â  function clearData() {
Â  Â  Â  Â  if(confirm('XÃ³a toÃ n bá»™ dá»¯ liá»‡u vÃ  reset?')) {
Â  Â  Â  Â  Â  Â  STATE.csvData = [];
Â  Â  Â  Â  Â  Â  STATE.currentIndex = 0;
Â  Â  Â  Â  Â  Â  STATE.isRunning = false;
Â  Â  Â  Â  Â  Â  updateUI();
Â  Â  Â  Â  Â  Â  log('ÄÃ£ xÃ³a dá»¯ liá»‡u.');
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // --- LOGIC CHÃNH ---
Â  Â  function startProcess() {
Â  Â  Â  Â  if (!STATE.templateId) return alert('Thiáº¿u Template ID!');
Â  Â  Â  Â  if (STATE.csvData.length === 0) return alert('Thiáº¿u dá»¯ liá»‡u CSV!');
Â  Â  Â  Â  STATE.isRunning = true;
Â  Â  Â  Â  processNext();
Â  Â  }

Â  Â  function stopProcess() {
Â  Â  Â  Â  STATE.isRunning = false;
Â  Â  Â  Â  log('ÄÃ£ dá»«ng.');
Â  Â  }

Â  Â  function processNext() {
Â  Â  Â  Â  if (!STATE.isRunning) return;
Â  Â  Â  Â  const rows = STATE.csvData;
Â  Â  Â  Â  if (STATE.currentIndex >= rows.length) {
Â  Â  Â  Â  Â  Â  STATE.isRunning = false;
Â  Â  Â  Â  Â  Â  log('HOÃ€N Táº¤T TOÃ€N Bá»˜!');
Â  Â  Â  Â  Â  Â  return alert('Xong háº¿t file CSV!');
Â  Â  Â  Â  }

Â  Â  Â  Â  const row = rows[STATE.currentIndex];
Â  Â  Â  Â  updateUI();

Â  Â  Â  Â  const copyUrl = `https://www.etsy.com/your/shops/me/listing-editor/copy/${STATE.templateId}`;
Â  Â  Â  Â  if (window.location.href.includes(copyUrl) || window.location.href.includes('/listing-editor/edit/')) {
Â  Â  Â  Â  Â  Â  runFilling(row);
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  log('Äang má»Ÿ trang Copy...');
Â  Â  Â  Â  Â  Â  window.location.href = copyUrl;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  async function runFilling(row) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  log('Äang xá»­ lÃ½ dÃ²ng ' + (STATE.currentIndex + 1));

Â  Â  Â  Â  Â  Â  // --- 1. TITLE ---
Â  Â  Â  Â  Â  Â  log('Chá» input Title...');
Â  Â  Â  Â  Â  Â  const titleInput = await waitForSelector(CONFIG.selectors.titleInput);
Â  Â  Â  Â  Â  Â  if (!titleInput) throw new Error('KhÃ´ng tháº¥y Ã´ Title');
Â  Â  Â  Â  Â  Â  await sleep(CONFIG.delay.load);

Â  Â  Â  Â  Â  Â  titleInput.focus();
Â  Â  Â  Â  Â  Â  await sleep(500);
Â  Â  Â  Â  Â  Â  await simulateTyping(titleInput, row.title, 20);
Â  Â  Â  Â  Â  Â  await sleep(CONFIG.delay.step);
Â  Â  Â  Â  Â  Â  titleInput.blur();

Â  Â  Â  Â  Â  Â  // --- 2. TAGS (Cáº­p nháº­t v2.5) ---
Â  Â  Â  Â  Â  Â  log('Cuá»™n Ä‘áº¿n khu vá»±c Tags...');
Â  Â  Â  Â  Â  Â  // Scroll tá»›i fieldset chá»©a tags
Â  Â  Â  Â  Â  Â  const tagSection = document.querySelector(CONFIG.selectors.tagSection);
Â  Â  Â  Â  Â  Â  if (tagSection) {
Â  Â  Â  Â  Â  Â  Â  Â  tagSection.scrollIntoView({ behavior: "smooth", block: "center" });
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  log('KhÃ´ng tháº¥y tag section, thá»­ scroll xuá»‘ng cuá»‘i...');
Â  Â  Â  Â  Â  Â  Â  Â  window.scrollTo(0, document.body.scrollHeight / 2);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  await sleep(1500); // Äá»£i scroll xong

Â  Â  Â  Â  Â  Â  const tagInput = document.querySelector(CONFIG.selectors.tagInput);
Â  Â  Â  Â  Â  Â  const tagAddBtn = document.querySelector(CONFIG.selectors.tagAddBtn);

Â  Â  Â  Â  Â  Â  if (row.tags && tagInput && tagAddBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  const tags = row.tags.split(',').map(t => t.trim()).filter(t => t).slice(0, 13);
Â  Â  Â  Â  Â  Â  Â  Â  log(`Báº¯t Ä‘áº§u Ä‘iá»n ${tags.length} tags...`);

Â  Â  Â  Â  Â  Â  Â  Â  // KHÃ”NG xÃ³a tag cÅ© theo yÃªu cáº§u

Â  Â  Â  Â  Â  Â  Â  Â  for (const tag of tags) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tagInput.focus();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tagInput.value = ''; // XÃ³a tráº¯ng Ã´ input trÆ°á»›c khi gÃµ

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // GÃµ ráº¥t cháº­m (100ms/char) Ä‘á»ƒ Ä‘áº£m báº£o nÃºt Add sÃ¡ng lÃªn
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await simulateTyping(tagInput, tag, CONFIG.delay.tagTyping);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await sleep(500); // Äá»£i nÃºt Add sÃ¡ng

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Click Add
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tagAddBtn.click();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Fallback: Nháº¥n Enter náº¿u click há»¥t
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tagInput.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter', code: 'Enter', bubbles: true }));

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Äá»£i lÃ¢u hÆ¡n Ä‘á»ƒ trÃ¡nh lá»—i
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await sleep(CONFIG.delay.tagWait);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  log('âš ï¸ KhÃ´ng tÃ¬m tháº¥y Ã´ nháº­p Tags hoáº·c khÃ´ng cÃ³ data Tags');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- 3. IMAGES ---
Â  Â  Â  Â  Â  Â  if (row.images && row.images.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  log(`Äang táº£i ${row.images.length} áº£nh...`);
Â  Â  Â  Â  Â  Â  Â  Â  const files = await fetchImagesAsFiles(row.images);
Â  Â  Â  Â  Â  Â  Â  Â  if (files.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  log('Upload áº£nh...');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await uploadFilesToEtsy(files);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  log(`â³ Äá»£i ${CONFIG.delay.uploadWait/1000}s load áº£nh...`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await sleep(CONFIG.delay.uploadWait);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // --- 4. PUBLISH ---
Â  Â  Â  Â  Â  Â  log('Cuá»™n xuá»‘ng Publish...');
Â  Â  Â  Â  Â  Â  window.scrollTo(0, document.body.scrollHeight);
Â  Â  Â  Â  Â  Â  await sleep(2000);

Â  Â  Â  Â  Â  Â  const pubBtn = await waitForSelector(CONFIG.selectors.publishBtn, 5000);
Â  Â  Â  Â  Â  Â  if (pubBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  log('Nháº¥n Publish...');
Â  Â  Â  Â  Â  Â  Â  Â  pubBtn.click();
Â  Â  Â  Â  Â  Â  Â  Â  await sleep(3000);

Â  Â  Â  Â  Â  Â  Â  Â  const confirmBtn = await waitForSelector(CONFIG.selectors.confirmModalBtn, 5000);
Â  Â  Â  Â  Â  Â  Â  Â  if (confirmBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  log('ÄÃ£ báº¥m Confirm Publish!');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  confirmBtn.click();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await waitForRedirect();
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â log('âš ï¸ Retry Publish láº§n 2...');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â pubBtn.click();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â await sleep(2000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const retryConfirm = document.querySelector(CONFIG.selectors.confirmModalBtn);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if(retryConfirm) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â retryConfirm.click();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â await waitForRedirect();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â throw new Error('Káº¹t á»Ÿ bÆ°á»›c Publish (KhÃ´ng tháº¥y nÃºt confirm)');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('KhÃ´ng tháº¥y nÃºt Publish chÃ­nh');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  Â  Â  log('Lá»—i: ' + e.message);
Â  Â  Â  Â  Â  Â  STATE.isRunning = false;
Â  Â  Â  Â  Â  Â  alert('CÃ³ lá»—i dá»«ng láº¡i: ' + e.message);
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // --- HELPERS ---
Â  Â  async function simulateTyping(input, text, speed) {
Â  Â  Â  Â  const prototype = (input.tagName === 'TEXTAREA')
Â  Â  Â  Â  ? window.HTMLTextAreaElement.prototype
Â  Â  Â  Â  : window.HTMLInputElement.prototype;
Â  Â  Â  Â  const nativeSetter = Object.getOwnPropertyDescriptor(prototype, "value").set;

Â  Â  Â  Â  for (let i = 1; i <= text.length; i++) {
Â  Â  Â  Â  Â  Â  const currentText = text.substring(0, i);
Â  Â  Â  Â  Â  Â  nativeSetter.call(input, currentText);

Â  Â  Â  Â  Â  Â  const tracker = input._valueTracker;
Â  Â  Â  Â  Â  Â  if (tracker) tracker.setValue('');

Â  Â  Â  Â  Â  Â  input.dispatchEvent(new Event('input', { bubbles: true }));

Â  Â  Â  Â  Â  Â  // Speed control
Â  Â  Â  Â  Â  Â  await new Promise(r => setTimeout(r, speed));
Â  Â  Â  Â  }
Â  Â  Â  Â  input.dispatchEvent(new Event('change', { bubbles: true }));
Â  Â  }

Â  Â  function waitForSelector(selector, timeout = 10000) {
Â  Â  Â  Â  return new Promise(resolve => {
Â  Â  Â  Â  Â  Â  if (document.querySelector(selector)) return resolve(document.querySelector(selector));
Â  Â  Â  Â  Â  Â  const observer = new MutationObserver(() => {
Â  Â  Â  Â  Â  Â  Â  Â  if (document.querySelector(selector)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve(document.querySelector(selector));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  observer.disconnect();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  observer.observe(document.body, { childList: true, subtree: true });
Â  Â  Â  Â  Â  Â  setTimeout(() => { observer.disconnect(); resolve(null); }, timeout);
Â  Â  Â  Â  });
Â  Â  }

Â  Â  async function fetchImagesAsFiles(urls) {
Â  Â  Â  Â  const filePromises = urls.map((url, index) => {
Â  Â  Â  Â  Â  Â  return new Promise((resolve) => {
Â  Â  Â  Â  Â  Â  Â  Â  GM_xmlhttpRequest({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: "GET", url: url, responseType: "blob",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onload: function(response) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (response.status === 200) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const blob = response.response;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const filename = `img_${Date.now()}_${index}.jpg`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve(new File([blob], filename, { type: "image/jpeg" }));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else resolve(null);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onerror: function() { resolve(null); }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  Â  const files = await Promise.all(filePromises);
Â  Â  Â  Â  return files.filter(f => f !== null);
Â  Â  }

Â  Â  async function uploadFilesToEtsy(files) {
Â  Â  Â  Â  const fileInput = document.querySelector(CONFIG.selectors.fileInput);
Â  Â  Â  Â  if (!fileInput) return;
Â  Â  Â  Â  const dataTransfer = new DataTransfer();
Â  Â  Â  Â  files.forEach(file => dataTransfer.items.add(file));
Â  Â  Â  Â  fileInput.files = dataTransfer.files;
Â  Â  Â  Â  fileInput.dispatchEvent(new Event('change', { bubbles: true }));
Â  Â  Â  Â  fileInput.dispatchEvent(new Event('input', { bubbles: true }));
Â  Â  Â  Â  const uploadArea = document.querySelector('.wt-upload__area') || fileInput;
Â  Â  Â  Â  uploadArea.scrollIntoView({behavior: "smooth", block: "center"});
Â  Â  }

Â  Â  async function waitForRedirect() {
Â  Â  Â  Â  log('Chá» chuyá»ƒn hÆ°á»›ng...');
Â  Â  Â  Â  return new Promise(resolve => {
Â  Â  Â  Â  Â  Â  const check = setInterval(() => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!window.location.href.includes('listing-editor/copy')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(check);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  STATE.currentIndex++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(processNext, 2500);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve();
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }, 1000);
Â  Â  Â  Â  });
Â  Â  }

Â  Â  function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

Â  Â  window.addEventListener('load', () => {
Â  Â  Â  Â  createPanel();
Â  Â  Â  Â  if (STATE.isRunning && window.location.href.includes('listing-editor')) {
Â  Â  Â  Â  Â  Â  const rows = STATE.csvData;
Â  Â  Â  Â  Â  Â  if (STATE.currentIndex < rows.length) runFilling(rows[STATE.currentIndex]);
Â  Â  Â  Â  }
Â  Â  });

})();
